# empeg core library Makefile
#
# (C) 1999-2000 empeg ltd.
#
# This software is licensed under the GNU General Public Licence (see file
# COPYING), unless you possess an alternative written licence from empeg ltd.
#
# (:Empeg Source Release 1.60.2.1 01-Apr-2003 18:52 rob:)
#
# Authors:
#   Mike Crowe <mac@empeg.com>

TOP=../..

include $(TOP)/Make.rules

TARGET_CXXFLAGS+=-D "_LIB"

SRC_COMMON:= \
	dospath2.cpp \
	dynamic_config_file.cpp \
	empeg_exception.cpp \
	empeg_time.cpp \
	file.cpp \
	file_stream.cpp \
	format_error.cpp \
	memory_stream.cpp \
	pstring.cpp \
	reblocker.cpp \
	serial.cpp \
	timeout.cpp \
	utf8.cpp \
	var_string.cpp \
	wildcard.cpp

SRC_THREADS:= \
	cyclecheck.cpp \
	mutex.cpp \
	thread_pid.cpp

SRC_NOTHREADS:= \
	thread_pid_fake.cpp

SRC_UNIX:= \
	dnew.cpp \
	mutexcycle.cpp \
	id3v1tags.cpp \
	refcount_posix.cpp \
	time_calc.cpp \
	trace.cpp

SRC_WIN32:= \
	trace_win32.cpp

ifeq ($(ARCH), win32)
TARGET_THREADS_SRC:=$(SRC_COMMON) $(SRC_WIN32) $(SRC_THREADS)
TARGET_NOTHREADS_SRC:=$(SRC_COMMAND) $(SRC_WIN32) $(SRC_NOTHREADS)
else
TARGET_THREADS_SRC:=$(SRC_COMMON) $(SRC_UNIX) $(SRC_THREADS)
TARGET_NOTHREADS_SRC:=$(SRC_COMMON) $(SRC_UNIX) $(SRC_NOTHREADS)
endif

TARGET_HEADERS=dnew.h trace.h filemagic.h pstring.h wildcard.h

TARGET_THREADS_OBJS:=$(TARGET_THREADS_SRC:%.c=$(TARGET_PREFIX)%$(OBJ_SUFFIX))
TARGET_THREADS_OBJS:=$(TARGET_THREADS_OBJS:%.cpp=$(TARGET_PREFIX)%$(OBJ_SUFFIX))
TARGET_THREADS_DEPS:=$(TARGET_THREADS_OBJS:$(OBJ_SUFFIX)=.d)

TARGET_NOTHREADS_OBJS:=$(TARGET_NOTHREADS_SRC:%.c=$(TARGET_PREFIX)%$(OBJ_SUFFIX))
TARGET_NOTHREADS_OBJS:=$(TARGET_NOTHREADS_OBJS:%.cpp=$(TARGET_PREFIX)%$(OBJ_SUFFIX))
TARGET_NOTHREADS_DEPS:=$(TARGET_NOTHREADS_OBJS:$(OBJ_SUFFIX)=.d)

THIS_TARGET=$(TARGET_GENERIC)

THREADS_TARGET=$(TARGET_GENERIC_LIBDIR)$(LIB_PREFIX)empeg_core$(LIB_SUFFIX)
NOTHREADS_TARGET=$(TARGET_GENERIC_LIBDIR)$(LIB_PREFIX)empeg_core_nothreads$(LIB_SUFFIX)

.PHONY: all

all : $(THREADS_TARGET) $(NOTHREADS_TARGET)

# Implicit rules will take care of this
$(THREADS_TARGET) : $(TARGET_THREADS_OBJS)

# Implicit rules will take care of this
$(NOTHREADS_TARGET) : $(TARGET_NOTHREADS_OBJS)

.PHONY: downloadable-root
downloadable-root: $(THREADS_TARGET) $(NOTHREADS_TARGET)

clean :
	$(RM) -rf $(TARGET_PREFIX) $(THREADS_TARGET) $(NOTHREADS_TARGET) .force-header-generation
	$(RM) core_errors.h wildcard
	$(RM) core *~

distclean : clean

cyclecheck: cyclecheck.cpp
	$(TARGET_CXX) cyclecheck.cpp $(TARGET_CXXFLAGS) -o cyclecheck-test.o -DTEST
	$(TARGET_LD) cyclecheck-test.o $(TARGET_LDFLAGS) -o cyclecheck

mutexcheck: mutexcycle.cpp $(THREADS_TARGET)
	$(TARGET_CXX) mutexcycle.cpp $(TARGET_CXXFLAGS) -o mutexcheck-test.o -DTEST
	$(TARGET_LD) mutexcheck-test.o $(TARGET_LDFLAGS) -o mutexcheck $(THREADS_TARGET) -lpthread

serial: serial.cpp
	$(TARGET_CXX) serial.cpp $(TARGET_CXXFLAGS) -o serial-test.o -DTEST
	$(TARGET_LD) serial-test.o $(TARGET_LDFLAGS) -o serial

TEST_SRC := tests.cpp wildcard_test.cpp
TEST_OBJS := $(TEST_SRC:%.cpp=$(TARGET_PREFIX)%$(OBJ_SUFFIX))

.PHONY: tests

tests: $(TARGET_PREFIX)tests$(EXE_SUFFIX)

$(TARGET_PREFIX)tests$(EXE_SUFFIX): $(TEST_OBJS) $(THREADS_TARGET) $(NOTHREADS_TARGET)
	$(MAKE) -C $(TOP)/lib/CppUnit
	$(TARGET_LD) $(TEST_OBJS) $(THREADS_TARGET) $(TARGET_LDFLAGS) \
		$(TARGET_GENERIC_LIBDIR)$(LIB_PREFIX)cppunit$(LIB_SUFFIX) -o $(TARGET_PREFIX)tests$(EXE_SUFFIX) -lpthread

runtests: tests
	$(TARGET_PREFIX)tests

core_errors.h: core_errors.mes $(ERRBUILD)
	$(ERRBUILD) -h -o core_errors core_errors.mes

# Automatically-generated headers
#
# These cause a problem, as they must exist before compilation starts, yet
# without these rules no dependency on them would exist except for the ones
# generated by compilation. We break this vicious circle by creating an (empty)
# sub-makefile; make remakes sub-makefiles before doing any real work and we
# can subvert this mechanism to make our generated headers too.

.force-header-generation: core_errors.h
	touch .force-header-generation

ifneq ($(CLEANING),1)
-include .force-header-generation
endif

ifneq ($(CLEANING),1)
TARGET_DEPS:=$(TARGET_OBJS:%$(OBJ_SUFFIX)=%.d) $(TEST_OBJS:%$(OBJ_SUFFIX)=%.d)
TARGET_DEPS:=$(wildcard $(TARGET_DEPS))
ifneq ($(TARGET_DEPS),)
-include $(TARGET_DEPS)
endif
endif
